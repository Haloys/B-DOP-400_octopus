- name: Install prerequisites for Node.js
  apt:
    name:
      - ca-certificates
      - curl
      - gnupg
    state: present

- name: Add Node.js apt key
  apt_key:
    url: https://deb.nodesource.com/gpgkey/nodesource-repo.gpg.key
    state: present

- name: Add Node.js repository
  apt_repository:
    repo: deb https://deb.nodesource.com/node_18.x bookworm main
    state: present
    filename: nodesource

- name: Install Node.js
  apt:
    name: nodejs
    state: present
    update_cache: yes

- name: Create result application directory
  file:
    path: /opt/result-app
    state: directory
    mode: '0755'

- name: Extract result application
  unarchive:
    src: "{{ playbook_dir }}/result.tar"
    dest: /opt/result-app
    mode: '0755'
    remote_src: no

- name: Install Node.js dependencies
  npm:
    path: /opt/result-app
    state: present

- name: Create systemd service file for result app
  copy:
    src: result.service
    dest: /etc/systemd/system/result.service
    mode: '0644'
  register: result_service_changed

- name: Restart Result Service if service config changed
  systemd:
    name: result
    state: restarted
    daemon_reload: yes
  when: result_service_changed.changed

- name: Ensure result service is enabled and started
  systemd:
    name: result
    enabled: yes
    state: started
    daemon_reload: yes
